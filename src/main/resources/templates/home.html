<!DOCTYPE html>
<html lang="en" xmlns:sec="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>OnlyPets | Home</title>
    <link rel="stylesheet" type="text/css" href="/global.css" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />

    <link rel="stylesheet" type="text/css" href="/home.css" />
    <script>
        function closeModal() {
            document.querySelector('.alert').remove();
        }
    </script>
</head>
<body>

<nav>
    <span id="nav-left">
        <a href="/" id="logo">OnlyPets</a>
    </span>

    <span id="nav-right">
        <!-- Spring security changes view based on authorization and role. Here, I did it based on auth to change the
         view from Login and Sign Up to Logout based on auth. _csrf is important for Spring Security and this reactive
          th value allows the form to be submitted. Otherwise, spring will prevent the post request -->

        <a href="/login" sec:authorize="isAnonymous()">Log in</a>
        <a href="/register" sec:authorize="isAnonymous()">Sign up</a>

        <form action="/logout" method="POST" sec:authorize="isAuthenticated()">
            <input type="submit" value="Logout" />
            <input type="hidden"
                   th:name="${_csrf.parameterName}"
                   th:value="${_csrf.token}"/>
        </form>

        <form action="/dashboard" method="POST" sec:authorize="isAuthenticated()">
            <input type="submit" value="Dashboard" />
            <input type="hidden"
                   th:name="${_csrf.parameterName}"
                   th:value="${_csrf.token}"/>
        </form>
    </span>
</nav>

<div class="alert alert-danger" role="alert" th:if="${error}">
    <span th:text="${error}" />
    <a onclick="closeModal()">Ok</a>
</div>
<form id="post" method="POST" action="/post" sec:authorize="isAuthenticated()" enctype="multipart/form-data">
    <input type="text" name="title" placeholder="Add a title to your post!" maxlength="75" />
    <input type="file" name="image" />
    <input type="submit" value="Post" />
    <input type="hidden" name="author" th:value="${#authentication.getPrincipal().getUsername()}" />
    <input type="hidden"
           th:name="${_csrf.parameterName}"
           th:value="${_csrf.token}"/>
</form>

<a sec:authorize="hasAnyAuthority('ADMIN') and hasAnyAuthority('MOD')" href="/dashboard">Dashboard</a>

<section>
    <div class="post" th:each="post : ${postList}">
        <h2 th:each="user : ${userService.getUserByUsername(post.author)}">
            <span class="header">
                <span class="user">
                    <img class="avatar" th:src="${user.avatar}" />
                    <a th:text="${user.username}"></a>
                </span>
            </span>
            <a th:text="${post.title}"></a>
        </h2>

        <span class="body"><img th:src="${post.picture}" /></span>

        <span class="footer">
            <i class="fa fa-thumbs-down" th:text="${post.dislikes}"></i>
            <i class="fa fa-thumbs-up" aria-hidden="true" th:text="${post.likes}"></i>
            <a sec:authorize="hasAnyAuthority('USER')">Report User</a>
            <a sec:authorize="hasAnyAuthority('USER')">Block User</a>
        </span>
    </div>
</section>

</body>
</html>